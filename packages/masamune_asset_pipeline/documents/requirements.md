# 自立して動くアセット作成システム

# コンセプト

CloudFunctions for Firebase（第２世代）側で動作

与えられたテーマやアセットに対して十分な調査や検証を経た後、映像、画像を生成し

それを自動でYouTubeやInstagram、Tiktok、AdobeStockなどのストックフォトにアップロードするアプリケーション。

- 内容は予め与えられているテーマ（チャンネルテーマ）やアセットから複数の映像、画像を随時作成
    - 予め短い文言でテーマが与えられるか、１枚画像、短い映像、音楽などアセットが与えられることもある。
    - １つのテーマから広く調査し複数の映像や画像を作成する
- 内容はDeepResearchもしくはそれに付随するレベルでの調査を経て決定
    - ２段階での調査
        1. 与えられたチャンネルテーマから広く調査し今回生成する映像や画像のテーマを決定するためのプロセス
            - 過去に作られた動画や画像と被っていないかも合わせてチェック
        2. 1で決定されたテーマに基づき動画や画像にするための深堀り調査のプロセス
            - Web検索も含めたDeepResearchが必要
- 動画はシーンごとに細かく分解しそれぞれで生成する（つまりシーン分割が重要）
- 動画の場合はさらにセクションごとにシーンの背景や音楽、ナレーションを細かく指定するためのデータ生成が必要（最終的に動画生成時に利用）
- 内容の調査結果やセクションの分割データ、セクションの詳細データはすべてFirestore経由で読み書きする
- 途中生成のアセット、および最終生成されたアセットについてはCloudStorage for Firebaseを利用
- 最終的に生成されたアセットを各種APIを通じてYouTube、Instagram、Tiktok、AdobeStockなどにアップロード。配信を行う。
    - 配信を行う最終チェックは各種サービスのコンソールから人間が行う。例えばYouTubeの場合は限定公開で公開しておき、最後は人間の手で一般公開を行う等。
- DeepResearchや動画の生成や合成は時間がかかるためCloudFunctions for Firebase（第２世代）のhttp呼び出しを用いて60分フルに使えるようにする
- Httpトリガーやスケジューラーを利用して手動、定期的な自動での生成どちらにも対応できるようにする
- AIで生成した素材アセットはラベル付けしFirestoreにベクターデータ含めて保存（実データはCloudStorageにアップロード）し後から使いまわしできるようにする

## 開発構成

- 開発についてはすべてTypeScriptで行う。（Masamuneフレームワークのバックエンド側の仕組みを用いる）
- 機能別に複数の関数に分ける
    - Httpトリガーで作成を開始する関数
        - チャンネルテーマや画像、映像、音声等のアセットを渡して作成リクエストを受け付けるメソッド
        - 各種データをFirestoreやStorageに保存して調査開始用の関数を叩く
    - スケジューラーで定期的に作成を開始する関数
        - Firestoreに保存されたチャンネルテーマおよび最終作成日時を参照し最終作成日時から一定時間経ったらチャンネルテーマに基づいたアセットの作成を行うために調査開始用の関数を叩く
    - 広域調査用関数
        - 開始関数から渡されたリクエスト or Firestoreに記載されたチャンネルテーマを基に今回のアセットで用いるテーマを決定
        - Webから広くテーマを収集
        - 各テーマにおいて被っているものがないかFirestoreからベクター検索
        - 被っていないテーマを１つ決定してFirestoreに保存（検索用のベクターデータも保存）し詳細調査用の関数を叩く
        - 例：
            - チャンネルテーマが「西洋の歴史」だとすれば「100年戦争」「フランス革命」などのイベント、「ヒトラー」や「ナポレオン」などの人物など、「西洋の城」などの構造物などが対象になる
    - 詳細調査用関数
        - 広域調査用関数からリクエストを受け起動
        - Web等を用いてDeepResearchを行う
        - 10分〜15分の動画に耐えうるだけの情報量を必ず揃えるようにする
        - 取得した情報はすべてFirestoreに保存する。生成するアセットの内容に応じて「ショート動画情報生成開始関数」「動画情報生成開始関数」「漫画情報生成関数」「画像情報生成関数」を叩く
    - ショート動画情報生成開始関数
        - 詳細調査用関数からリクエストを受け開始。
        - 詳細調査用のデータをFirestoreから取得して60秒程度のショート動画生成用のメタデータを作成する
        - ここでは動画全体のメタデータ、ショート動画の概要→ショート動画の詳細データを作成する
        - 動画のメタデータは下記を記載
            - 動画タイトル
            - 動画概要
            - プロモーション用テキスト
            - キーワード
            - 対応言語
        - ショート動画の概要は下記を記載
            - 動画の詳細
            - 映像の雰囲気
            - 音楽の雰囲気
        - ショート動画の概要を作成した後それを基にしてショート動画の詳細テキストデータを作成
            - 映像の動き、音楽の雰囲気、演出（効果音含め）、ナレーションの文言をすべて生成
                - 映像は映像生成AIに渡さず、「画像生成AIで画像を出力 or Firestoreを検索して既存のものを利用」→「ffmegのフィルターやトランジション、パンやズームを駆使して画像を動かす」という形で作成
                    - 事前にFirestoreを検索しすでに生成された画像で合うものがあればそれを利用する
                    - 画像の細かい描写（そのままプロンプトとして渡してその通りの画像ができるまで描写）
                    - ffmpegに渡して動きをつけるための指示用データ（Json等で構造を定義したうえでそこに記載）
                    - 画像は動画の長さによっては複数作ってもよい
                - BGMや効果音もそのままプロンプトとして使えるように長さや雰囲気、使用する楽器まで細かく記載
                    - Firestoreを検索しすでに生成されたものがあればそれを利用するように指定
                - ナレーションは動画の長さに合うように文章の長さを調整
                - ドーパミンを生成しやすいようにテンポ早め光と音の演出多め（不自然にならないように）にする
        - 動画メタデータやショート動画の内容をすべてFirestoreに保存して「ショート動画生成関数」を叩く
    - ショート動画生成関数
        - ショート動画情報生成関数からリクエストを受け開始
        - 流れとしては下記の流れで作成
            1. Google Text-to-Speechにナレーション文言を渡し音声を作成
                - シーンの長さに合うように調整
            2. ナレーション音声に合う形でBGMをStorageから取得 or Lyriaを使って生成しffmpegを使って合成
                - AIを使って生成した音声はラベルを付けてベクターデータにしたあとFirestore＆Storageに保存
                - ffmpegのダッキングを使ってナレーションを際立たせる形で合成
            3. 音声の長さに合わせて画像を生成 or CloudStorageから画像を取得しffmpegで画像を動かし動画を作成、それを音声に合成させる
            4. 完成した動画をCloudStorageにアップロード
        - 動画を生成し終えたら動画完了フラグを立て「動画配信関数」を叩く
        - 生成された動画の秒数を基にYouTube用の字幕データも合わせて作成、CloudStorageに保存
    - 動画情報生成開始関数
        - 詳細調査用関数からリクエストを受け開始。
        - 詳細調査用のデータをFirestoreから取得して動画生成用のメタデータを作成する
        - ここでは動画全体のメタデータ、シーン分割およびシーンの概要データを作成する
        - 詳細調査用のデータから動画としての説明しやすいようにシーンを分割していく
        - 動画のメタデータは下記を記載
            - 動画タイトル
            - 動画概要
            - プロモーション用テキスト
            - キーワード
            - 対応言語
        - それぞれのシーンに下記データを記載
            - シーン名
            - シーンの秒数（内容に応じて増減）
            - シーンの詳細
            - 映像の雰囲気
            - 音楽の雰囲気
        - すべてのシーンを合わせて最大10分程度になるように調整
        - 動画メタデータやシーンの内容をすべてFirestoreに保存してシーンごとにそれぞれ「シーン動画情報生成関数」を叩く
    - シーン動画情報生成関数
        - 動画情報生成開始関数からリクエストを受け開始
        - シーンごとに並列で起動
        - 動画生成を行うためのシーン内の動きをこと細かく生成
        - 映像の動き、音楽の雰囲気、演出（効果音含め）、ナレーションの文言をすべて生成
            - 映像は映像生成AIに渡さず、「画像生成AIで画像を出力 or Firestoreを検索して既存のものを利用」→「ffmegのフィルターやトランジション、パンやズームを駆使して画像を動かす」という形で作成
                - 事前にFirestoreを検索しすでに生成された画像で合うものがあればそれを利用する
                - 画像の細かい描写（そのままプロンプトとして渡してその通りの画像ができるまで描写）
                - ffmpegに渡して動きをつけるための指示用データ（Json等で構造を定義したうえでそこに記載）
                - 画像はシーンの長さによっては複数作ってもよい
            - BGMや効果音もそのままプロンプトとして使えるように長さや雰囲気、使用する楽器まで細かく記載
                - Firestoreを検索しすでに生成されたものがあればそれを利用するように指定
            - ナレーションはシーンの長さに合うように文章の長さを調整
            - ドーパミンを生成しやすいようにテンポ早め光と音の演出多め（不自然にならないように）にする
        - 生成した動画情報はFirestoreに保存し「シーン動画生成関数」を叩く
    - シーン動画生成関数
        - シーン動画情報生成関数からリクエストを受け開始
        - シーン動画情報生成関数からの流れで実行されるのでこちらもシーンごとに並列で起動
        - 流れとしては下記の流れで作成
            1. Google Text-to-Speechにナレーション文言を渡し音声を作成
                - シーンの長さに合うように調整
            2. ナレーション音声に合う形でBGMをStorageから取得 or Lyriaを使って生成しffmpegを使って合成
                - AIを使って生成した音声はラベルを付けてベクターデータにしたあとFirestore＆Storageに保存
                - ffmpegのダッキングを使ってナレーションを際立たせる形で合成
            3. 音声の長さに合わせて画像を生成 or CloudStorageから画像を取得しffmpegで画像を動かし動画を作成、それを音声に合成させる
            4. 完成した動画をCloudStorageにアップロード
        - シーンに必要なすべての動画を生成し終えたらFirestoreのシーンの動画完了フラグをONにし「動画合成関数」を叩く
        - 生成された動画の秒数を基にYouTube用の字幕データも合わせて作成、CloudStorageに保存
    - 動画合成関数
        - 動画合成関数からリクエストを受け開始
        - すべてのシーンにおいてシーンの動画完了フラグが立っているかを確認し立っていたら開始
        - すべてのシーン合成動画を順番通りに繋ぎ合わせる
        - すべての動画を繋ぎ合わせたらFirestoreの動画生成完了フラグを立て「動画配信関数」を叩く
    - 漫画情報生成関数
        - 詳細調査用関数からリクエストを受け開始。
        - 詳細調査用のデータをFirestoreから取得してA4１ページに収まる漫画のメタデータを作成する
        - ここでは漫画全体のメタデータ、漫画の概要→漫画の詳細データを作成する
        - 漫画のメタデータは下記を記載
            - 漫画タイトル
            - 漫画概要
            - プロモーション用テキスト
            - キーワード
            - 対応言語
        - 漫画の概要は下記を記載
            - 漫画の詳細
            - イラストの雰囲気
            - セリフの雰囲気
        - 漫画の概要を作成した後それを基にして漫画の詳細テキストデータを作成
            - コマごとの画像の細かい描写、セリフをすべて作成
                - そのままプロンプトとして渡すとその通りの画像が生成できるところまでテキスト情報を生成
                - ドーパミンを生成しやすいようにテンポ早め（不自然にならないように）にする
        - 漫画メタデータや漫画の内容をすべてFirestoreに保存して「漫画生成関数」を叩く
    - 漫画生成関数
        - 漫画情報生成関数からリスエストを受け開始。
        - GeminiのNanoBananaから画像を生成
        - 実際にGeminiにプロンプトを渡して画像を生成しCloudStorageに保存。
        - 画像を生成し終えたら画像完了フラグを立て「画像配信関数」を叩く
    - 画像情報生成関数
        - 詳細調査用関数からリクエストを受け開始。
        - 詳細調査用のデータをFirestoreから取得して画像のメタデータを作成する
        - ここでは画像全体のメタデータ、画像の概要→画像の詳細データを作成する
        - 画像のメタデータは下記を記載
            - 画像タイトル
            - 画像概要
            - プロモーション用テキスト
            - キーワード
            - 対応言語
        - 漫画の概要は下記を記載
            - 画像の詳細
            - 画像の雰囲気
        - 画像の概要を作成した後それを基にして画像の詳細テキストデータを作成
            - 画像全体の詳細の描画を作成
                - そのままプロンプトとして渡すとその通りの画像が生成できるところまでテキスト情報を生成
        - 画像メタデータや画像の内容をすべてFirestoreに保存して「画像生成関数」を叩く
    - 画像生成関数
        - 画像情報生成関数からリスエストを受け開始。
        - GeminiのNanoBananaから画像を生成
        - 実際にGeminiにプロンプトを渡して画像を生成しCloudStorageに保存。
        - 画像を生成し終えたら画像完了フラグを立て「画像配信関数」を叩く
    - 動画配信関数
        - 完成した動画を各種配信サイトにアップロードするための開始関数
        - Firestoreのデータ（チャンネルテーマと同じドキュメント）に保存されている配信先一覧を基に各種配信関数を叩く
    - 画像配信関数
        - 完成した画像を各種配信サイトにアップロードするための開始関数
        - Firestoreのデータ（チャンネルテーマと同じドキュメント）に保存されている配信先一覧を基に各種配信関数を叩く
    - YouTube配信関数
        - ショート動画および通常動画を扱う
        - 動画配信関数にYouTubeがリストアップされていたらこちらがリクエストされる
        - 完成した動画をYouTubeのAPIを通して配信手続きを行う。
        - 動画のメタデータを読み込み、API経由で設定
        - 字幕データが存在すればそれも合わせて設定。
        - 限定公開して公開したらメール等で通知するようにする。
    - Instagram配信関数
        - ショート動画および画像を扱う
        - 動画配信関数や画像配信関数にInstagramがリストアップされていたらこちらがリクエストされる
        - 完成したショート動画や画像をInstagramのAPIを通して配信手続きを行う。
        - 動画や画像のメタデータを読み込み、API経由で設定
    - TikTok配信関数
        - ショート動画を扱う
        - 動画配信関数や画像配信関数にTikTokがリストアップされていたらこちらがリクエストされる
        - 完成したショート動画や画像をTikTokのAPIを通して配信手続きを行う。
        - 動画のメタデータを読み込み、API経由で設定
    - X（Twitter）配信関数
        - ショート動画および画像を扱う
        - 動画配信関数や画像配信関数にXがリストアップされていたらこちらがリクエストされる
        - 完成したショート動画や画像をXのAPIを通して配信手続きを行う。
        - 動画や画像のメタデータを読み込み、API経由で設定
    - AdobeStock配信関数
        - 画像を扱う
        - 画像配信関数にAdobeStockがリストアップされていたらこちらがリクエストされる
        - 完成した画像をAdobeStockのAPIを通して配信手続きを行う。
        - 画像のメタデータを読み込み、API経由で設定
    - Suzuri配信関数
        - 画像を扱う
        - 画像配信関数にSuzuriがリストアップされていたらこちらがリクエストされる
        - 完成した画像をSuzuriのAPIを通して配信手続きを行う。
        - 画像のメタデータを読み込み、API経由で設定

## システム要件

- src/以下にソースコードを配置する
- src/functions/以下にFirestore CloudFunctionsのデータが格納されているので他の関数の記載内容に従って実装を行う
